{% extends 'base.html' %}

{% block content %}
<div class="card">
    <h1>Upload Joplin Database</h1>
    <p>Upload your <code>database.sqlite</code> file to enable semantic search.</p>

    {% if settings_mismatch %}
    <div
        style="background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>⚠️ RAG Settings Change Detected</strong>
        <p>The next upload will trigger an <strong>automatic full re-index</strong> because your indexing parameters
            have changed. This will ensure your embeddings are consistent with your current configuration.</p>
        <div style="margin-top: 10px; font-size: 0.9em;">
            <div style="margin-bottom: 5px;">
                <strong>Old Settings:</strong>
                Size: {{ old_chunk_size|default:"Unknown" }},
                Overlap: {{ old_chunk_overlap|default:"Unknown" }}
            </div>
            <div>
                <strong>New Settings (from .env):</strong>
                Size: {{ current_chunk_size }},
                Overlap: {{ current_chunk_overlap }}
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div>
            <label for="id_file">Database File (.sqlite):</label>
            <input type="file" name="file" id="id_file" required accept=".sqlite">
        </div>
        {% if last_upload %}
        <p>
            <strong>Last Upload Status:</strong>
            {% if last_upload.processed %}
            <span style="color: green;">✓ Processed on {{ last_upload.uploaded_at|date:"Y-m-d H:i" }}</span>
            {% else %}
            <span style="color: orange;">⟳ Processing... (Refresh page to check status)</span>
            {% endif %}
        </p>
        {% if last_upload.processed %}
        <p>
            <strong>Results:</strong>
            {{ last_upload.new_notes_count }} new,
            {{ last_upload.updated_notes_count }} updated.
        </p>
        {% endif %}
        {% endif %}
        <button type="submit" class="btn">Upload & Process</button>
    </form>
</div>

<div class="card">
    <h2>Instructions</h2>
    <ol>
        <li>Locate your Joplin profile directory.</li>
        <li>Copy the <code>database.sqlite</code> file.</li>
        <li>Upload it here.</li>
        <li>Wait for processing to complete (this may take a few minutes depending on database size).</li>
    </ol>
</div>
{% endblock %}